var ge=Object.defineProperty;var _e=(n,t,a)=>t in n?ge(n,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):n[t]=a;var ae=(n,t,a)=>(_e(n,typeof t!="symbol"?t+"":t,a),a);import"./base-066e358f.js";import{E as he}from"./el-button-36ff5d7c.js";import{_ as I,a2 as H,t as A,o as p,c as D,L as C,M as z,U as j,i as u,G as M,F as k,j as W,B as Y,v as V,r as S,C as x,Y as q,E as U,H as se,R as K,am as ye,an as be,ar as O,w as le,b as R,D as ce,a6 as ue,P as de,a9 as De,a as ne,S as X,I as E}from"./index-4d5ea235.js";import{C as Ne}from"./index-95b7de42.js";import"./index-67a0f3ab.js";import"./index-4739abb4.js";const we=["onClick"],$e={key:0,class:"line"},Ce={__name:"AddNodeBtn",props:{endLine:{type:Boolean,default:!0},addType:{type:String,default:"node"}},emits:["toAdd"],setup(n,{emit:t}){const a=n,e=H(),c=A("addNodeDialogRef"),o=m=>{if(m.id==="canvas-main"||!m)return{x:0,y:0};const v=o(m.offsetParent);return{x:v.x+m.offsetLeft,y:v.y+m.offsetTop}},s=m=>{t("toAdd",m)},r=W(),_=m=>{if(a.addType==="branch")return t("toAdd");const{target:v,offsetY:B}=m,{x:d,y:h}=o(v);c.value.show({x:v.clientWidth+d,y:B+h},s,r)};return(m,v)=>(p(),D(k,null,[C("div",z({class:"add-node"},u(e),{onClick:j(_,["stop"])})," + ",16,we),n.endLine?(p(),D("div",$e)):M("",!0)],64))}},J=I(Ce,[["__scopeId","data-v-77b265a2"]]);const Le=["onClick"],Ve={__name:"SubBtn",emits:["toSub"],setup(n,{emit:t}){const a=A("hoverStack"),e=c=>{a.value=[],t("toSub")};return(c,o)=>(p(),D("div",{class:"sub-node",onClick:j(e,["stop"])}," - ",8,Le))}},ie=I(Ve,[["__scopeId","data-v-554bf87e"]]),Be={},Se={class:"node-wrapper"},ke=C("div",{class:"c-circle c-start"}," start ",-1),Ae=[ke];function xe(n,t){return p(),D("div",Se,Ae)}const Ie=I(Be,[["render",xe]]),Me={},Pe={class:"node-wrapper"},Oe=C("div",{class:"c-circle c-end"}," end ",-1),Re=[Oe];function je(n,t){return p(),D("div",Pe,Re)}const Fe=I(Me,[["render",je]]),Te={},Ee={class:"node-wrapper"},Ue=C("div",{class:"c-circle c-other"}," Error ",-1);function He(n,t){return p(),D("div",Ee,[Y(n.$slots,"default"),Ue])}const G=I(Te,[["render",He]]),Q=n=>{var t;return n?(t=n==null?void 0:n.branchList)!=null&&t.length?n.branchList.reduce((a,e)=>a+Math.max(...e.map(c=>Q(c)),1),0):1:0},oe=n=>Array.isArray(n)?Math.max(...n.map(t=>Q(t)),1):1,ze=C("div",{class:"line"},null,-1),pe={__name:"BranchRender",props:{modelValue:{type:Object,default:()=>({})},curNode:{type:Object,default:()=>({})}},emits:["addBranch","removeBranch","update:modelValue"],setup(n,{emit:t}){const a=n,e=V({get:()=>a.modelValue||[],set:l=>t("update:modelValue",l)}),c=V(()=>Q(a.curNode)),o=V(()=>{var l;return oe((l=e.value)==null?void 0:l[0])}),s=V(()=>{var l;return oe((l=e.value)==null?void 0:l[e.value.length-1])}),r=A("activateNode"),_=A("hoverStack"),m=V(()=>_.value[0]),v=l=>_.value.unshift(e.value[l]),B=l=>_.value.shift(),d=S(null),h=l=>{d.value=l,e.value[l]},N=()=>{d.value=null},g=l=>{d.value!==null&&l.preventDefault()},f=l=>{if(!(d.value===l||d.value===null)){if(d.value<l){const b=e.value[d.value];e.value.splice(l+1,0,b),e.value.splice(d.value,1)}else{const b=e.value.splice(d.value,1)[0];e.value.splice(l,0,b)}d.value=null}},i=l=>{r.value=e.value[l]};return(l,b)=>(p(),D(k,null,[ze,n.curNode.type==="switch"?(p(),x(J,{key:0,class:"on-bottom","end-line":!1,"add-type":"branch",onToAdd:b[0]||(b[0]=w=>t("addBranch"))})):M("",!0),C("div",{class:"branch-wrapper branch-wrapper-width",style:se({"--var-col-count":u(c),"--var-first-branch-col-count":u(o),"--var-last-branch-col-count":u(s)})},[(p(!0),D(k,null,q(u(e),(w,y)=>(p(),x(ve,{key:y,modelValue:u(e)[y],"onUpdate:modelValue":L=>u(e)[y]=L,class:U({"hover-branch":u(m)===u(e)[y]||u(r)===u(e)[y],"can-drop-branch":d.value!==null&&d.value!==y}),"branch-count":u(e).length,draggable:!0,onMouseenter:()=>v(y),onMouseleave:()=>B(),onRemoveBranch:()=>t("removeBranch",y),onDragstart:j(()=>h(y),["stop"]),onDragover:b[1]||(b[1]=L=>g(L)),onDropCapture:()=>f(y),onDragend:N,onClick:j(()=>i(y),["stop"])},null,8,["modelValue","onUpdate:modelValue","class","branch-count","onMouseenter","onMouseleave","onRemoveBranch","onDragstart","onDropCapture","onClick"]))),128))],4)],64))}},Ye=C("div",{class:"c-circle c-if"}," if ",-1),Ke={__name:"If",props:{modelValue:{type:Object,default:()=>({})},isPreview:{type:Boolean,default:!1}},emits:["update:modelValue"],setup(n,{emit:t}){const a=n,e=V({get:()=>a.modelValue.branchList,set:s=>t("update:modelValue",{...a.modelValue,branchList:s})}),c=H(),o=s=>{var r;return s?(r=s==null?void 0:s.branchList)!=null&&r.length?s.branchList.reduce((_,m)=>_+Math.max(...m.map(v=>o(v)),1),0):1:0};return V(()=>o(a.modelValue)),(s,r)=>(p(),D(k,null,[C("div",z({class:"node-wrapper"},u(c)),[Y(s.$slots,"default"),Ye],16),n.isPreview?M("",!0):(p(),x(pe,{key:0,modelValue:u(e),"onUpdate:modelValue":r[0]||(r[0]=_=>K(e)?e.value=_:null),"cur-node":n.modelValue},null,8,["modelValue","cur-node"]))],64))}};const Xe=n=>(ye("data-v-653f9187"),n=n(),be(),n),Ge=Xe(()=>C("div",{class:"c-circle c-switch"}," switch ",-1)),We={__name:"Switch",props:{modelValue:{type:Object,default:()=>({})},isPreview:{type:Boolean,default:!1}},emits:["update:modelValue"],setup(n,{emit:t}){const a=n,e=V({get:()=>a.modelValue.branchList||[],set:r=>t("update:modelValue",{...a.modelValue,branchList:r})}),c=H(),o=()=>{e.value.push([])},s=r=>{e.value.splice(r,1)};return(r,_)=>(p(),D(k,null,[C("div",z({class:"node-wrapper"},u(c)),[Y(r.$slots,"default",{},void 0,!0),Ge],16),n.isPreview?M("",!0):(p(),x(pe,{key:0,modelValue:u(e),"onUpdate:modelValue":_[0]||(_[0]=m=>K(e)?e.value=m:null),"cur-node":n.modelValue,onAddBranch:o,onRemoveBranch:s},null,8,["modelValue","cur-node"]))],64))}},qe=I(We,[["__scopeId","data-v-653f9187"]]),Je={},Qe={class:"node-wrapper"},Ze=C("div",{class:"c-circle c-feat"}," Feat ",-1);function et(n,t){return p(),D("div",Qe,[Y(n.$slots,"default"),Ze])}const tt=I(Je,[["render",et]]),Z=[{type:"start",component:O(Ie),generateNode:()=>new $("start")},{type:"end",component:O(Fe),generateNode:()=>new $("end")},{type:"if",component:O(Ke),generateNode:()=>new $("if")},{type:"switch",component:O(qe),generateNode:(n=[[],[]])=>new $("switch",{branchList:n})},{type:"feat",component:O(tt),generateNode:()=>new $("feat")}],P=2,re=(n,t=P)=>{const a=n==null?void 0:n.filter(Array.isArray);return a!=null&&a.length?t?a.length>=t?a.slice(0,t):a.slice().concat(new Array(t-a.length).fill(0).map(e=>[])):a.slice():new Array(t).fill(0).map(e=>[])},T=class{constructor(t,a){const{branchList:e=[],parentNode:c=null,branchIdx:o=null}=a||{};if(Object.defineProperty(this,"id",{configurable:!1,writable:!1,value:++T.id}),Object.defineProperty(this,"type",{configurable:!1,writable:!1,value:Z.some(s=>s.type===t)?t:"error"}),Object.defineProperty(this,"parentNode",{configurable:!1,value:c}),t==="if"){let s=re(e);Object.defineProperty(this,"branchList",{configurable:!1,get:()=>s,set(r){if(r.length!==P)throw new G(`分支数量必须为${P}`);console.log("val.length",r.length),s=r}}),Object.defineProperty(this,"branchIdx",{configurable:!1,value:o})}if(t==="switch"){let s=re(e,0);Object.defineProperty(this,"branchList",{configurable:!1,get:()=>s,set(r){if(r.length<P)throw new G(`分支数量至少为${P}`);s=r}}),Object.defineProperty(this,"branchIdx",{configurable:!1,value:o})}}static copyBranchList(t){return(t==null?void 0:t.map(a=>(a==null?void 0:a.map(e=>e.copySelf()))||[]))||[]}copySelf(){return new T(this.type,{branchList:T.copyBranchList(this.branchList)})}toString(){return`{${Object.getOwnPropertyNames(this).reduce((t,a)=>{let e=`${t},${a}:`;return Array.isArray(this[a])?e+=`[${this[a].toString()}]`:typeof this[a]=="number"?e+=`${this[a].toString()}`:typeof this[a]=="string"&&(e+=`"${this[a].toString()}"`),e},"").slice(1)}}`}};let $=T;ae($,"id",0);const at={type:"error",component:O(G),generateNode:()=>new $("error")},F=(n,t,a=null)=>{for(let e in n){e=e-0;const c=n[e];if(c===t)return{nodeList:n,parentNode:a,nodeIdx:e,branchIdx:null};for(let o in c.branchList||[]){o=o-0;const s=c.branchList[o];if(s===t)return{nodeList:s,parentNode:c,branchIdx:o,nodeIdx:null};const r=F(s,t,c);if(r)return r}}return null},nt=["draggable","onDragstart","onClick"],ot=C("div",{class:"line"},null,-1),rt={__name:"RenderItem",props:{modelValue:{type:Object,default:()=>({})},nodeList:{type:Array,default:()=>[]}},emits:["update:modelValue","update:nodeList","addNode","subNode","moveTo"],setup(n,{emit:t}){const a=n,e=V({get:()=>a.modelValue,set:w=>t("update:modelValue",w)}),c=V({get:()=>a.nodeList,set:w=>t("update:nodeList",w)}),o=V(()=>(Z.find(w=>w.type===e.value.type)||at).component),s=A("hoverStack"),r=A("dragConf"),_=A("activateNode"),m=V(()=>s.value[0]),v=()=>s.value.unshift(e.value),B=()=>s.value.shift(),d=()=>{r.value.customDragData={node:e.value,curBranch:c.value,target:null};const w=[],y=(L,fe)=>{var ee;!fe&&w.push(L),(ee=L==null?void 0:L.branchList)!=null&&ee.length&&L.branchList.forEach(te=>{w.push(te),te.forEach(me=>y(me))})};y(e.value,!0),r.value.dragFlag=!0,r.value.banDropNodeList=w},h=()=>{r.value.dragFlag=!1,r.value.banDropNodeList=[]},N=W(),g=()=>{r.value.customDragData&&(r.value.banDropNodeList.includes(e)||ue(r.value.customDragData.target)===N&&(t("moveTo",r.value.customDragData.node,r.value.customDragData.curBranch),r.value.customDragData=null,s.value=[]))},f=()=>{r.value.customDragData&&(r.value.customDragData.target=N)},i=()=>{r.value.customDragData&&(r.value.customDragData.target=null)},l=w=>{r.value.dragFlag&&!r.value.banDropNodeList.includes(e.value)&&w.preventDefault()},b=()=>{_.value=e.value};return(w,y)=>(p(),D(k,null,[C("div",{draggable:!["start","end"].includes(u(e).type),class:U({"node-box":!["start","end"].includes(u(e).type),"hover-node":u(m)===u(e)||u(_)===u(e),"no-branch-box":!["if","switch"].includes(u(e).type)}),onMouseenter:v,onMouseleave:B,onDragstart:j(d,["stop"]),onDragend:h,onClick:j(b,["stop"])},[(p(),x(ce(u(o)),{modelValue:u(e),"onUpdate:modelValue":y[1]||(y[1]=L=>K(e)?e.value=L:null)},{default:le(()=>[R(ie,{onToSub:y[0]||(y[0]=L=>t("subNode"))})]),_:1},8,["modelValue"]))],42,nt),u(e).type!=="end"?(p(),D(k,{key:0},[ot,R(J,{class:U({canDropFlag:u(r).dragFlag&&!u(r).banDropNodeList.includes(u(e))}),onToAdd:y[2]||(y[2]=L=>t("addNode",L)),onDragover:l,onDrop:g,onDragenter:f,onDragleave:i},null,8,["class"])],64)):M("",!0)],64))}},st=C("div",{class:"line"},null,-1),ve={__name:"RenderList",props:{modelValue:{type:Array,default:()=>[]},startLine:{type:Boolean,default:!0},branchCount:{type:Number,default:1}},emits:["update:modelValue","removeBranch"],setup(n,{emit:t}){const a=n,e=H(),c=V({get:()=>a.modelValue,set:g=>t("update:modelValue",g)}),o=A("dragConf"),s=A("hoverStack"),r=(g,f)=>{const i=f.generateNode();c.value.splice(g+1,0,i)},_=(g,f,i)=>{const l=f.findIndex(b=>b===g);if(f===c.value){if(l===i+1||l===i)return;l>i?(f.splice(l,1),f.splice(i+1,0,g)):(f.splice(i+1,0,g),f.splice(l,1))}else f.splice(l,1),c.value.splice(i+1,0,g)},m=g=>{c.value.splice(g,1)},v=W(),B=()=>{o.value.customDragData&&(o.value.banDropNodeList.includes(c)||ue(o.value.customDragData.target)===v&&(_(o.value.customDragData.node,o.value.customDragData.curBranch,-1),s.value=[],o.value.customDragData=null))},d=()=>{o.value.customDragData&&(o.value.customDragData.target=v)},h=()=>{o.value.customDragData&&(o.value.customDragData.target=null)},N=g=>{o.value.dragFlag&&!o.value.banDropNodeList.includes(c.value)&&g.preventDefault()};return(g,f)=>(p(),D("div",z({class:"render-list-wrapper"},u(e)),[n.startLine?(p(),D(k,{key:0},[n.branchCount>2?(p(),x(ie,{key:0,onClick:f[0]||(f[0]=i=>t("removeBranch"))})):M("",!0),st,R(J,{class:U({canDropFlag:u(o).dragFlag&&!u(o).banDropNodeList.includes(u(c))}),droppable:u(o).dragFlag&&!u(o).banDropNodeList.includes(u(c)),onToAdd:f[1]||(f[1]=i=>r(-1,i)),onDragover:N,onDrop:B,onDragenter:d,onDragleave:h},null,8,["class","droppable"])],64)):M("",!0),(p(!0),D(k,null,q(u(c),(i,l)=>(p(),x(rt,{key:i.id,modelValue:u(c)[l],"onUpdate:modelValue":b=>u(c)[l]=b,"node-list":u(c),"onUpdate:nodeList":f[2]||(f[2]=b=>K(c)?c.value=b:null),onAddNode:b=>r(l,b),onSubNode:()=>m(l),onMoveTo:(b,w)=>_(b,w,l)},null,8,["modelValue","onUpdate:modelValue","node-list","onAddNode","onSubNode","onMoveTo"]))),128))],16))}};const lt={class:"select-node-wrapper"},ct={__name:"AddNodeDialog",setup(n,{expose:t}){const a=S({x:1,y:1}),e=S(!1);let c,o;const s=()=>{e.value=!1,c=null,o=null},r=(v,B,d)=>{if(o===d)return s();o=d,c=B,a.value=v,e.value=!0},_=v=>{c==null||c(v),s()},m=S(Z.filter(v=>!["start","end"].includes(v.type)));return t({show:r,close:s}),(v,B)=>de((p(),D("div",{class:"add-node-dialog",style:se({"--var-dialog-left":`${a.value.x}px`,"--var-dialog-top":`${a.value.y}px`,"--var-dialog-size":e.value?"300px":"0"})},[C("div",lt,[(p(!0),D(k,null,q(m.value,d=>(p(),x(ce(d.component),{key:d.type,"is-preview":!0,onClick:()=>_(d)},null,8,["onClick"]))),128))])],4)),[[u(Ne),s]])}},ut=I(ct,[["__scopeId","data-v-7f77c4dd"]]);const dt={__name:"Main",setup(n){const t=S([new $("start"),new $("feat"),new $("switch",{branchList:[[new $("feat")],[new $("feat")],[new $("feat")]]}),new $("end")]);console.log(t.value);const a=S(null);E("addNodeDialogRef",a);const e=S([]);E("hoverStack",e);const c=S({banDropNodeList:[],dragFlag:!1,customDragData:null});E("dragConf",c);const o=S(null);E("activateNode",o);const s=S(null),r=()=>{var i;const d=o.value;if(!d)return;const{parentNode:h,branchIdx:N,nodeList:g,nodeIdx:f}=F(t.value,o.value,null);if(Array.isArray(d)){if(((i=h.branchList)==null?void 0:i.length)<=P)throw new Error(`分支数量至少为${P},剪切失败！`);(h.branchList||[]).splice(N,1)}else g.splice(f,1);s.value={type:"shear",data:d}},_=()=>{const d=o.value;d&&(s.value={type:"copy",data:d})},m=d=>{if(!s.value)return;const{type:h,data:N}=s.value;if(!N)return;const g={copyNode:()=>{if(!o.value||Array.isArray(o.value))return;const{nodeList:i,nodeIdx:l}=F(t.value,o.value,null);console.log({branchNodeList:i,nodeIdx:l}),i.splice(l+1,0,N.copySelf())},shearNode:()=>{if(!o.value||Array.isArray(o.value))return;const{nodeList:i,nodeIdx:l}=F(t.value,o.value,null);i.splice(l+1,0,N),s.value=null},copyBranch:()=>{var i;((i=o.value)==null?void 0:i.type)==="switch"&&o.value.branchList.push(N.map(l=>l.copySelf()))},shearBranch:()=>{var i;((i=o.value)==null?void 0:i.type)==="switch"&&(o.value.branchList.push(N),s.value=null)}},f=h+(Array.isArray(N)?"Branch":"Node");g[f]()},v=S(!0),B=()=>{v.value=!v.value};return(d,h)=>{const N=he,g=De("mousetrap");return p(),D("div",{id:"canvas-main",class:"canvas-main",onClickCapture:h[3]||(h[3]=f=>o.value=null)},[R(N,{onClick:B},{default:le(()=>[ne(" 快捷建："+X(v.value?"开启":"关闭"),1)]),_:1}),R(ve,{modelValue:t.value,"onUpdate:modelValue":h[0]||(h[0]=f=>t.value=f),"start-line":!1},null,8,["modelValue"]),ne(" "+X(s.value)+" "+X(u(F)(t.value,o.value,null))+" ",1),R(ut,{ref_key:"addNodeDialogRef",ref:a},null,512),v.value?de((p(),D("div",{key:0,"onMod+c":h[1]||(h[1]=()=>_()),"onMod+x":h[2]||(h[2]=()=>r()),"onMod+v":m},null,544)),[[g,["mod+c","mod+v","mod+x"]]]):M("",!0)],32)}}},it=I(dt,[["__scopeId","data-v-6cf73f90"]]),yt={__name:"index",setup(n){return(t,a)=>(p(),x(it))}};export{yt as default};
