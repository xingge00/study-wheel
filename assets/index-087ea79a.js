var ie=Object.defineProperty;var _e=(n,t,o)=>t in n?ie(n,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):n[t]=o;var Z=(n,t,o)=>(_e(n,typeof t!="symbol"?t+"":t,o),o);import{_ as B,a2 as Y,e as R,o as d,c as p,E as h,G as H,U as P,j as s,y as D,F as V,q as M,f as b,s as L,Y as X,z as ne,R as j,am as pe,an as fe,ar as x,w as ve,b as F,v as oe,x as E,g as ae,r as k,P as me,A as T}from"./index-602d1ac0.js";import{C as ge}from"./index-325a4ae6.js";import"./types-2a216b00.js";const he=["onClick"],we={key:0,class:"line"},be={__name:"AddNodeBtn",props:{endLine:{type:Boolean,default:!0},addType:{type:String,default:"node"}},emits:["toAdd"],setup(n,{emit:t}){const o=n,e=Y(),l=R("addNodeDialogRef"),u=r=>{if(r.id==="canvas-main"||!r)return{x:0,y:0};const i=u(r.offsetParent);return{x:i.x+r.offsetLeft,y:i.y+r.offsetTop}},c=r=>{t("toAdd",r)},a=r=>{if(o.addType==="branch")return t("toAdd");const{x:i,y:v}=u(r.target);l.value.show({x:r.offsetX+i,y:r.offsetY+v},c)};return(r,i)=>(d(),p(V,null,[h("div",H({class:"add-node"},s(e),{onClick:P(a,["stop"])})," + ",16,he),n.endLine?(d(),p("div",we)):D("",!0)],64))}},q=B(be,[["__scopeId","data-v-b9d5c136"]]);const ye=["onClick"],Ne={__name:"SubBtn",emits:["toSub"],setup(n,{emit:t}){const o=e=>t("toSub");return(e,l)=>(d(),p("div",{class:"sub-node",onClick:P(o,["stop"])}," - ",8,ye))}},se=B(Ne,[["__scopeId","data-v-77d9fe80"]]),Ve={},$e={class:"node-wrapper"},Ce=h("div",{class:"c-circle c-start"}," start ",-1),Le=[Ce];function Be(n,t){return d(),p("div",$e,Le)}const ke=B(Ve,[["render",Be]]),Ae={},De={class:"node-wrapper"},xe=h("div",{class:"c-circle c-end"}," end ",-1),Se=[xe];function Ie(n,t){return d(),p("div",De,Se)}const Re=B(Ae,[["render",Ie]]),Fe={},Te={class:"node-wrapper"},Pe=h("div",{class:"c-circle c-other"}," Error ",-1);function Me(n,t){return d(),p("div",Te,[M(n.$slots,"default"),Pe])}const z=B(Fe,[["render",Me]]),G=n=>{var t;return n?(t=n==null?void 0:n.branchList)!=null&&t.length?n.branchList.reduce((o,e)=>o+Math.max(...e.map(l=>G(l)),1),0):1:0},ee=n=>Array.isArray(n)?Math.max(...n.map(t=>G(t)),1):1,je=h("div",{class:"line"},null,-1),le={__name:"BranchRender",props:{modelValue:{type:Object,default:()=>({})},curNode:{type:Object,default:()=>({})}},emits:["addBranch","removeBranch","update:modelValue"],setup(n,{emit:t}){const o=n,e=b({get:()=>o.modelValue||[],set:a=>t("update:modelValue",a)}),l=b(()=>G(o.curNode)),u=b(()=>{var a;return ee((a=e.value)==null?void 0:a[0])}),c=b(()=>{var a;return ee((a=e.value)==null?void 0:a[e.value.length-1])});return(a,r)=>(d(),p(V,null,[je,n.curNode.type==="switch"?(d(),L(q,{key:0,class:"on-bottom","end-line":!1,"add-type":"branch",onToAdd:r[0]||(r[0]=i=>t("addBranch"))})):D("",!0),h("div",{class:"branch-wrapper branch-wrapper-width",style:ne({"--var-col-count":s(l),"--var-first-branch-col-count":s(u),"--var-last-branch-col-count":s(c)})},[(d(!0),p(V,null,X(s(e),(i,v)=>(d(),L(re,{key:v,modelValue:s(e)[v],"onUpdate:modelValue":$=>s(e)[v]=$,"branch-count":s(e).length,onRemoveBranch:()=>t("removeBranch",v)},null,8,["modelValue","onUpdate:modelValue","branch-count","onRemoveBranch"]))),128))],4)],64))}},Oe=h("div",{class:"c-circle c-if"}," if ",-1),Ue={__name:"If",props:{modelValue:{type:Object,default:()=>({})},isPreview:{type:Boolean,default:!1}},emits:["update:modelValue"],setup(n,{emit:t}){const o=n,e=b({get:()=>o.modelValue.branchList,set:c=>t("update:modelValue",{...o.modelValue,branchList:c})}),l=Y(),u=c=>{var a;return c?(a=c==null?void 0:c.branchList)!=null&&a.length?c.branchList.reduce((r,i)=>r+Math.max(...i.map(v=>u(v)),1),0):1:0};return b(()=>u(o.modelValue)),(c,a)=>(d(),p(V,null,[h("div",H({class:"node-wrapper"},s(l)),[M(c.$slots,"default"),Oe],16),n.isPreview?D("",!0):(d(),L(le,{key:0,modelValue:s(e),"onUpdate:modelValue":a[0]||(a[0]=r=>j(e)?e.value=r:null),"cur-node":n.modelValue},null,8,["modelValue","cur-node"]))],64))}};const Ee=n=>(pe("data-v-653f9187"),n=n(),fe(),n),ze=Ee(()=>h("div",{class:"c-circle c-switch"}," switch ",-1)),Ye={__name:"Switch",props:{modelValue:{type:Object,default:()=>({})},isPreview:{type:Boolean,default:!1}},emits:["update:modelValue"],setup(n,{emit:t}){const o=n,e=b({get:()=>o.modelValue.branchList||[],set:a=>t("update:modelValue",{...o.modelValue,branchList:a})}),l=Y(),u=()=>{e.value.push([])},c=a=>{e.value.splice(a,1)};return(a,r)=>(d(),p(V,null,[h("div",H({class:"node-wrapper"},s(l)),[M(a.$slots,"default",{},void 0,!0),ze],16),n.isPreview?D("",!0):(d(),L(le,{key:0,modelValue:s(e),"onUpdate:modelValue":r[0]||(r[0]=i=>j(e)?e.value=i:null),"cur-node":n.modelValue,onAddBranch:u,onRemoveBranch:c},null,8,["modelValue","cur-node"]))],64))}},He=B(Ye,[["__scopeId","data-v-653f9187"]]),Xe={},qe={class:"node-wrapper"},Ge=h("div",{class:"c-circle c-feat"}," Feat ",-1);function Je(n,t){return d(),p("div",qe,[M(n.$slots,"default"),Ge])}const Ke=B(Xe,[["render",Je]]),J=[{type:"start",component:x(ke),generateNode:()=>new f("start")},{type:"end",component:x(Re),generateNode:()=>new f("end")},{type:"if",component:x(Ue),generateNode:()=>new f("if")},{type:"switch",component:x(He),generateNode:(n=[[],[]])=>new f("switch",{branchList:n})},{type:"feat",component:x(Ke),generateNode:()=>new f("feat")}],I=2,te=(n,t=I)=>{const o=n==null?void 0:n.filter(Array.isArray);return o!=null&&o.length?t?o.length>=t?o.slice(0,t):o.slice().concat(new Array(t-o.length).fill(0).map(e=>[])):o.slice():new Array(t).fill(0).map(e=>[])},K=class{constructor(t,o={branchList:[]}){const{branchList:e}=o;if(Object.defineProperty(this,"id",{configurable:!1,writable:!1,value:++K.id}),Object.defineProperty(this,"type",{configurable:!1,writable:!1,value:J.some(l=>l.type===t)?t:"error"}),t==="if"){let l=te(e);Object.defineProperty(this,"branchList",{configurable:!1,get:()=>l,set(u){if(u.length!==I)throw new z(`分支数量必须为${I}`);l=u}})}if(t==="switch"){let l=te(e,0);Object.defineProperty(this,"branchList",{configurable:!1,get:()=>l,set(u){if(u.length<I)throw new z(`分支数量至少为${I}`);l=u}})}}};let f=K;Z(f,"id",0);const Qe={type:"error",component:x(z),generateNode:()=>new f("error")},We=["draggable","onDragstart","onClick"],Ze=h("div",{class:"line"},null,-1),et={__name:"RenderItem",props:{modelValue:{type:Object,default:()=>({})},nodeList:{type:Array,default:()=>[]}},emits:["update:modelValue","update:nodeList","addNode","subNode","moveTo"],setup(n,{emit:t}){const o=n,e=b({get:()=>o.modelValue,set:C=>t("update:modelValue",C)}),l=b({get:()=>o.nodeList,set:C=>t("update:nodeList",C)}),u=b(()=>(J.find(C=>C.type===e.value.type)||Qe).component),c=R("hoverStack"),a=R("dragConf"),r=R("activateNode"),i=b(()=>c.value[0]),v=()=>c.value.unshift(e.value),$=()=>c.value.shift(),O=C=>{window.__custom_drop_data={node:e.value,curBranch:l.value,target:null};const N=[],A=(S,ce)=>{var Q;!ce&&N.push(S),(Q=S==null?void 0:S.branchList)!=null&&Q.length&&S.branchList.forEach(W=>{N.push(W),W.forEach(ue=>A(ue))})};A(e.value,!0),console.log("banNodeList",N),a.value.dragFlag=!0,a.value.banNodeList=N},m=()=>{setTimeout(()=>{a.value.dragFlag=!1,a.value.banNodeList=[]},100)},_=ae(),g=()=>{console.log("dragConf.value.banNodeList",a.value.banNodeList),!a.value.banNodeList.includes(e)&&window.__custom_drop_data.target===_&&(t("moveTo",window.__custom_drop_data.node,window.__custom_drop_data.curBranch),window.__custom_drop_data=null)},w=()=>{window.__custom_drop_data.target=_},y=()=>{window.__custom_drop_data.target=null},U=C=>{a.value.dragFlag&&!a.value.banNodeList.includes(e.value)&&C.preventDefault()},de=()=>{r.value=e.value};return(C,N)=>(d(),p(V,null,[h("div",{draggable:!["start","end"].includes(s(e).type),class:E({"node-box":!["start","end"].includes(s(e).type),"hover-node":s(i)===s(e)||s(r)===s(e),"no-branch-box":!["if","switch"].includes(s(e).type)}),onMouseenter:v,onMouseleave:$,onDragstart:P(O,["stop"]),onDragend:m,onClick:P(de,["stop"])},[(d(),L(oe(s(u)),{modelValue:s(e),"onUpdate:modelValue":N[1]||(N[1]=A=>j(e)?e.value=A:null)},{default:ve(()=>[F(se,{onToSub:N[0]||(N[0]=A=>t("subNode"))})]),_:1},8,["modelValue"]))],42,We),s(e).type!=="end"?(d(),p(V,{key:0},[Ze,F(q,{class:E({canDropFalg:s(a).dragFlag&&!s(a).banNodeList.includes(s(e))}),onToAdd:N[2]||(N[2]=A=>t("addNode",A)),onDragover:U,onDrop:g,onDragenter:w,onDragleave:y},null,8,["class"])],64)):D("",!0)],64))}},tt={class:"render-list-wrapper"},nt=h("div",{class:"line"},null,-1),re={__name:"RenderList",props:{modelValue:{type:Array,default:()=>[]},startLine:{type:Boolean,default:!0},branchCount:{type:Number,default:1}},emits:["update:modelValue","removeBranch"],setup(n,{emit:t}){const o=n,e=b({get:()=>o.modelValue,set:m=>t("update:modelValue",m)}),l=R("dragConf"),u=(m,_)=>{const g=_.generateNode();e.value.splice(m+1,0,g)},c=(m,_,g)=>{const w=_.findIndex(y=>y===m);if(_===e.value){if(w===g+1||w===g)return;w>g?(_.splice(w,1),_.splice(g+1,0,m)):(_.splice(g+1,0,m),_.splice(w,1))}else _.splice(w,1),e.value.splice(g+1,0,m)},a=m=>{e.value.splice(m,1)},r=ae(),i=()=>{l.value.banNodeList.includes(e)||window.__custom_drop_data.target===r&&(c(window.__custom_drop_data.node,window.__custom_drop_data.curBranch,-1),window.__custom_drop_data=null)},v=()=>{window.__custom_drop_data.target=r},$=()=>{window.__custom_drop_data.target=null},O=m=>{l.value.dragFlag&&!l.value.banNodeList.includes(e.value)&&m.preventDefault()};return(m,_)=>(d(),p("div",tt,[n.startLine?(d(),p(V,{key:0},[n.branchCount>2?(d(),L(se,{key:0,onClick:_[0]||(_[0]=g=>t("removeBranch"))})):D("",!0),nt,F(q,{class:E({canDropFalg:s(l).dragFlag&&!s(l).banNodeList.includes(s(e))}),droppable:s(l).dragFlag&&!s(l).banNodeList.includes(s(e)),onToAdd:_[1]||(_[1]=g=>u(-1,g)),onDragover:O,onDrop:i,onDragenter:v,onDragleave:$},null,8,["class","droppable"])],64)):D("",!0),(d(!0),p(V,null,X(s(e),(g,w)=>(d(),L(et,{key:g.id,modelValue:s(e)[w],"onUpdate:modelValue":y=>s(e)[w]=y,"node-list":s(e),"onUpdate:nodeList":_[2]||(_[2]=y=>j(e)?e.value=y:null),onAddNode:y=>u(w,y),onSubNode:()=>a(w),onMoveTo:(y,U)=>c(y,U,w)},null,8,["modelValue","onUpdate:modelValue","node-list","onAddNode","onSubNode","onMoveTo"]))),128))]))}};const ot={class:"select-node-wrapper"},at={__name:"AddNodeDialog",setup(n,{expose:t}){const o=k({x:1,y:1}),e=k(!1);let l;const u=(i,v)=>{l=v,o.value=i,e.value=!0},c=()=>{e.value=!1},a=i=>{c(),l(i)},r=k(J.filter(i=>!["start","end"].includes(i.type)));return t({show:u,close:c}),(i,v)=>me((d(),p("div",{class:"add-node-dialog",style:ne({"--var-dialog-left":`${o.value.x}px`,"--var-dialog-top":`${o.value.y}px`,"--var-dialog-size":e.value?"300px":"0"})},[h("div",ot,[(d(!0),p(V,null,X(r.value,$=>(d(),L(oe($.component),{key:$.type,"is-preview":!0,onClick:()=>a($)},null,8,["onClick"]))),128))])],4)),[[s(ge),c]])}},st=B(at,[["__scopeId","data-v-97bc81a4"]]);const lt={__name:"Main",setup(n){const t=k([new f("start"),new f("feat"),new f("switch",{branchList:[[new f("feat")],[new f("feat")],[new f("feat")]]}),new f("end")]);console.log(t.value);const o=k(null);T("addNodeDialogRef",o);const e=k([]);T("hoverStack",e);const l=k({banDropNodeList:[],dragFlag:!1});T("dragConf",l);const u=k(null);return T("activateNode",u),(c,a)=>(d(),p("div",{id:"canvas-main",class:"canvas-main",onClickCapture:a[1]||(a[1]=r=>u.value=null)},[F(re,{modelValue:t.value,"onUpdate:modelValue":a[0]||(a[0]=r=>t.value=r),"start-line":!1},null,8,["modelValue"]),F(st,{ref_key:"addNodeDialogRef",ref:o},null,512)],32))}},rt=B(lt,[["__scopeId","data-v-72e3213a"]]),_t={__name:"index",setup(n){return(t,o)=>(d(),L(rt))}};export{_t as default};
