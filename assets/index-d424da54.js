var ue=Object.defineProperty;var ie=(n,t,o)=>t in n?ue(n,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):n[t]=o;var Q=(n,t,o)=>(ie(n,typeof t!="symbol"?t+"":t,o),o);import{_ as C,a2 as E,e as T,o as c,c as p,E as h,G as z,U as I,j as a,y as x,F as V,q as P,f as y,s as L,Y,z as ee,R as M,am as _e,an as pe,ar as D,w as fe,b as R,v as te,x as O,a as ne,S as oe,g as ae,r as A,P as me,A as j}from"./index-da72d22c.js";import{C as ve}from"./index-4823d0c0.js";import"./types-6043764b.js";const ge=["onClick"],he={key:0,class:"line"},be={__name:"AddNodeBtn",props:{endLine:{type:Boolean,default:!0},addType:{type:String,default:"node"}},emits:["toAdd"],setup(n,{emit:t}){const o=n,e=E(),r=T("addNodeDialogRef"),u=d=>{if(d.id==="canvas-main"||!d)return{x:0,y:0};const i=u(d.offsetParent);return{x:i.x+d.offsetLeft,y:i.y+d.offsetTop}},l=d=>{t("toAdd",d)},s=d=>{if(o.addType==="branch")return t("toAdd");const{x:i,y:v}=u(d.target);r.value.show({x:d.offsetX+i,y:d.offsetY+v},l)};return(d,i)=>(c(),p(V,null,[h("div",z({class:"add-node"},a(e),{onClick:I(s,["stop"])})," + ",16,ge),n.endLine?(c(),p("div",he)):x("",!0)],64))}},H=C(be,[["__scopeId","data-v-b9d5c136"]]);const we=["onClick"],ye={__name:"SubBtn",emits:["toSub"],setup(n,{emit:t}){const o=e=>t("toSub");return(e,r)=>(c(),p("div",{class:"sub-node",onClick:I(o,["stop"])}," - ",8,we))}},se=C(ye,[["__scopeId","data-v-77d9fe80"]]),Ne={},Ve={class:"node-wrapper"},$e=h("div",{class:"c-circle c-start"}," start ",-1),Le=[$e];function Ce(n,t){return c(),p("div",Ve,Le)}const Be=C(Ne,[["render",Ce]]),ke={},Ae={class:"node-wrapper"},xe=h("div",{class:"c-circle c-end"}," end ",-1),De=[xe];function Se(n,t){return c(),p("div",Ae,De)}const Fe=C(ke,[["render",Se]]),Ie={},Re={class:"node-wrapper"},Te=h("div",{class:"c-circle c-other"}," Error ",-1);function Pe(n,t){return c(),p("div",Re,[P(n.$slots,"default"),Te])}const U=C(Ie,[["render",Pe]]),X=n=>{var t;return n?(t=n==null?void 0:n.branchList)!=null&&t.length?n.branchList.reduce((o,e)=>o+Math.max(...e.map(r=>X(r)),1),0):1:0},W=n=>Array.isArray(n)?Math.max(...n.map(t=>X(t)),1):1,Me=h("div",{class:"line"},null,-1),re={__name:"BranchRender",props:{modelValue:{type:Object,default:()=>({})},curNode:{type:Object,default:()=>({})}},emits:["addBranch","removeBranch","update:modelValue"],setup(n,{emit:t}){const o=n,e=y({get:()=>o.modelValue||[],set:s=>t("update:modelValue",s)}),r=y(()=>X(o.curNode)),u=y(()=>{var s;return W((s=e.value)==null?void 0:s[0])}),l=y(()=>{var s;return W((s=e.value)==null?void 0:s[e.value.length-1])});return(s,d)=>(c(),p(V,null,[Me,n.curNode.type==="switch"?(c(),L(H,{key:0,class:"on-bottom","end-line":!1,"add-type":"branch",onToAdd:d[0]||(d[0]=i=>t("addBranch"))})):x("",!0),h("div",{class:"branch-wrapper branch-wrapper-width",style:ee({"--var-col-count":a(r),"--var-first-branch-col-count":a(u),"--var-last-branch-col-count":a(l)})},[(c(!0),p(V,null,Y(a(e),(i,v)=>(c(),L(le,{key:v,modelValue:a(e)[v],"onUpdate:modelValue":$=>a(e)[v]=$,"branch-count":a(e).length,onRemoveBranch:()=>t("removeBranch",v)},null,8,["modelValue","onUpdate:modelValue","branch-count","onRemoveBranch"]))),128))],4)],64))}},je=h("div",{class:"c-circle c-if"}," if ",-1),Oe={__name:"If",props:{modelValue:{type:Object,default:()=>({})},isPreview:{type:Boolean,default:!1}},emits:["update:modelValue"],setup(n,{emit:t}){const o=n,e=y({get:()=>o.modelValue.branchList,set:l=>t("update:modelValue",{...o.modelValue,branchList:l})}),r=E(),u=l=>{var s;return l?(s=l==null?void 0:l.branchList)!=null&&s.length?l.branchList.reduce((d,i)=>d+Math.max(...i.map(v=>u(v)),1),0):1:0};return y(()=>u(o.modelValue)),(l,s)=>(c(),p(V,null,[h("div",z({class:"node-wrapper"},a(r)),[P(l.$slots,"default"),je],16),n.isPreview?x("",!0):(c(),L(re,{key:0,modelValue:a(e),"onUpdate:modelValue":s[0]||(s[0]=d=>M(e)?e.value=d:null),"cur-node":n.modelValue},null,8,["modelValue","cur-node"]))],64))}};const Ue=n=>(_e("data-v-653f9187"),n=n(),pe(),n),Ee=Ue(()=>h("div",{class:"c-circle c-switch"}," switch ",-1)),ze={__name:"Switch",props:{modelValue:{type:Object,default:()=>({})},isPreview:{type:Boolean,default:!1}},emits:["update:modelValue"],setup(n,{emit:t}){const o=n,e=y({get:()=>o.modelValue.branchList||[],set:s=>t("update:modelValue",{...o.modelValue,branchList:s})}),r=E(),u=()=>{e.value.push([])},l=s=>{e.value.splice(s,1)};return(s,d)=>(c(),p(V,null,[h("div",z({class:"node-wrapper"},a(r)),[P(s.$slots,"default",{},void 0,!0),Ee],16),n.isPreview?x("",!0):(c(),L(re,{key:0,modelValue:a(e),"onUpdate:modelValue":d[0]||(d[0]=i=>M(e)?e.value=i:null),"cur-node":n.modelValue,onAddBranch:u,onRemoveBranch:l},null,8,["modelValue","cur-node"]))],64))}},Ye=C(ze,[["__scopeId","data-v-653f9187"]]),He={},Xe={class:"node-wrapper"},qe=h("div",{class:"c-circle c-feat"}," Feat ",-1);function Ge(n,t){return c(),p("div",Xe,[P(n.$slots,"default"),qe])}const Je=C(He,[["render",Ge]]),q=[{type:"start",component:D(Be),generateNode:()=>new m("start")},{type:"end",component:D(Fe),generateNode:()=>new m("end")},{type:"if",component:D(Oe),generateNode:()=>new m("if")},{type:"switch",component:D(Ye),generateNode:(n=[[],[]])=>new m("switch",{branchList:n})},{type:"feat",component:D(Je),generateNode:()=>new m("feat")}],F=2,Z=(n,t=F)=>{const o=n==null?void 0:n.filter(Array.isArray);return o!=null&&o.length?t?o.length>=t?o.slice(0,t):o.slice().concat(new Array(t-o.length).fill(0).map(e=>[])):o.slice():new Array(t).fill(0).map(e=>[])},G=class{constructor(t,o={branchList:[]}){const{branchList:e}=o;if(Object.defineProperty(this,"id",{configurable:!1,writable:!1,value:++G.id}),Object.defineProperty(this,"type",{configurable:!1,writable:!1,value:q.some(r=>r.type===t)?t:"error"}),t==="if"){let r=Z(e);Object.defineProperty(this,"branchList",{configurable:!1,get:()=>r,set(u){if(u.length!==F)throw new U(`分支数量必须为${F}`);r=u}})}if(t==="switch"){let r=Z(e,0);Object.defineProperty(this,"branchList",{configurable:!1,get:()=>r,set(u){if(u.length<F)throw new U(`分支数量至少为${F}`);r=u}})}}};let m=G;Q(m,"id",0);const Ke={type:"error",component:D(U),generateNode:()=>new m("error")},Qe=["draggable","onDragstart"],We=h("div",{class:"line"},null,-1),Ze={__name:"RenderItem",props:{modelValue:{type:Object,default:()=>({})},nodeList:{type:Array,default:()=>[]}},emits:["update:modelValue","update:nodeList","addNode","subNode","moveTo"],setup(n,{emit:t}){const o=n,e=y({get:()=>o.modelValue,set:N=>t("update:modelValue",N)}),r=y({get:()=>o.nodeList,set:N=>t("update:nodeList",N)}),u=y(()=>(q.find(N=>N.type===e.value.type)||Ke).component),l=T("hoverStack"),s=T("dragConf"),d=y(()=>l.value[0]),i=()=>l.value.unshift(e.value),v=()=>l.value.shift(),$=N=>{window.__custom_drop_data={node:e.value,curBranch:r.value,target:null};const w=[],k=(S,de)=>{var J;!de&&w.push(S),(J=S==null?void 0:S.branchList)!=null&&J.length&&S.branchList.forEach(K=>{w.push(K),K.forEach(ce=>k(ce))})};k(e.value,!0),console.log("banNodeList",w),s.value.dragFlag=!0,s.value.banNodeList=w},b=()=>{setTimeout(()=>{s.value.dragFlag=!1,s.value.banNodeList=[]},100)},_=ae(),g=()=>{console.log("dragConf.value.banNodeList",s.value.banNodeList),!s.value.banNodeList.includes(e)&&window.__custom_drop_data.target===_&&(t("moveTo",window.__custom_drop_data.node,window.__custom_drop_data.curBranch),window.__custom_drop_data=null)},B=()=>{window.__custom_drop_data.target=_},f=()=>{window.__custom_drop_data.target=null};return(N,w)=>(c(),p(V,null,[h("div",{draggable:!["start","end"].includes(a(e).type),class:O(["node-box",{"hover-node":a(d)===a(e),"border-box":["if","switch"].includes(a(e).type)}]),onMouseenter:i,onMouseleave:v,onDragstart:I($,["stop"]),onDragend:b},[(c(),L(te(a(u)),{modelValue:a(e),"onUpdate:modelValue":w[1]||(w[1]=k=>M(e)?e.value=k:null)},{default:fe(()=>[R(se,{onToSub:w[0]||(w[0]=k=>t("subNode"))})]),_:1},8,["modelValue"]))],42,Qe),a(e).type!=="end"?(c(),p(V,{key:0},[We,ne(" "+oe(a(s).dragFlag&&!a(s).banNodeList.includes(a(e)))+" ",1),R(H,{class:O({canDropFalg:a(s).dragFlag&&!a(s).banNodeList.includes(a(e))}),dropgable:a(s).dragFlag&&!a(s).banNodeList.includes(a(e)),onToAdd:w[2]||(w[2]=k=>t("addNode",k)),onDragover:w[3]||(w[3]=I(()=>{},["prevent"])),onDrop:g,onDragenter:B,onDragleave:f},null,8,["class","dropgable"])],64)):x("",!0)],64))}},et={class:"render-list-wrapper"},tt=h("div",{class:"line"},null,-1),le={__name:"RenderList",props:{modelValue:{type:Array,default:()=>[]},startLine:{type:Boolean,default:!0},branchCount:{type:Number,default:1}},emits:["update:modelValue","removeBranch"],setup(n,{emit:t}){const o=n,e=y({get:()=>o.modelValue,set:b=>t("update:modelValue",b)}),r=T("dragConf"),u=(b,_)=>{const g=_.generateNode();e.value.splice(b+1,0,g)},l=(b,_,g,B)=>{const f=_.findIndex(N=>N===b);if(_===e.value){if(f===g+1||f===g)return;f>g?(_.splice(f,1),_.splice(g+1,0,b)):(_.splice(g+1,0,b),_.splice(f,1))}else _.splice(f,1),e.value.splice(g+1,0,b)},s=b=>{e.value.splice(b,1)},d=ae(),i=()=>{r.value.banNodeList.includes(e)||window.__custom_drop_data.target===d&&(l(window.__custom_drop_data.node,window.__custom_drop_data.curBranch,0),window.__custom_drop_data=null)},v=()=>{window.__custom_drop_data.target=d},$=()=>{window.__custom_drop_data.target=null};return(b,_)=>(c(),p("div",et,[n.startLine?(c(),p(V,{key:0},[n.branchCount>2?(c(),L(se,{key:0,onClick:_[0]||(_[0]=g=>t("removeBranch"))})):x("",!0),tt,ne(" "+oe(a(r).dragFlag&&!a(r).banNodeList.includes(a(e)))+" ",1),R(H,{class:O({canDropFalg:a(r).dragFlag&&!a(r).banNodeList.includes(a(e))}),dropgable:a(r).dragFlag&&!a(r).banNodeList.includes(a(e)),onToAdd:_[1]||(_[1]=g=>u(-1,g)),onDragover:_[2]||(_[2]=I(()=>{},["prevent"])),onDrop:i,onDragenter:v,onDragleave:$},null,8,["class","dropgable"])],64)):x("",!0),(c(!0),p(V,null,Y(a(e),(g,B)=>(c(),L(Ze,{key:g.id,modelValue:a(e)[B],"onUpdate:modelValue":f=>a(e)[B]=f,"node-list":a(e),"onUpdate:nodeList":_[3]||(_[3]=f=>M(e)?e.value=f:null),onAddNode:f=>u(B,f),onSubNode:()=>s(B),onMoveTo:(f,N)=>l(f,N,B)},null,8,["modelValue","onUpdate:modelValue","node-list","onAddNode","onSubNode","onMoveTo"]))),128))]))}};const nt={class:"select-node-wrapper"},ot={__name:"AddNodeDialog",setup(n,{expose:t}){const o=A({x:1,y:1}),e=A(!1);let r;const u=(i,v)=>{r=v,o.value=i,e.value=!0},l=()=>{e.value=!1},s=i=>{l(),r(i)},d=A(q.filter(i=>!["start","end"].includes(i.type)));return t({show:u,close:l}),(i,v)=>me((c(),p("div",{class:"add-node-dialog",style:ee({"--var-dialog-left":`${o.value.x}px`,"--var-dialog-top":`${o.value.y}px`,"--var-dialog-size":e.value?"300px":"0"})},[h("div",nt,[(c(!0),p(V,null,Y(d.value,$=>(c(),L(te($.component),{key:$.type,"is-preview":!0,onClick:()=>s($)},null,8,["onClick"]))),128))])],4)),[[a(ve),l]])}},at=C(ot,[["__scopeId","data-v-97bc81a4"]]);const st={id:"canvas-main",class:"canvas-main"},rt={__name:"Main",setup(n){const t=A([new m("start"),new m("feat"),new m("switch",{branchList:[[new m("feat")],[new m("feat")],[new m("feat")]]}),new m("end")]);console.log(t.value);const o=A(null);j("addNodeDialogRef",o);const e=A([]);j("hoverStack",e);const r=A({banDropNodeList:[],dragFlag:!1});return j("dragConf",r),(u,l)=>(c(),p("div",st,[R(le,{modelValue:t.value,"onUpdate:modelValue":l[0]||(l[0]=s=>t.value=s),"start-line":!1},null,8,["modelValue"]),R(at,{ref_key:"addNodeDialogRef",ref:o},null,512)]))}},lt=C(rt,[["__scopeId","data-v-47cd4f65"]]),_t={__name:"index",setup(n){return(t,o)=>(c(),L(lt))}};export{_t as default};
